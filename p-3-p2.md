# **üîß Pr√°ctica 3 Modificada: Servir la P√°gina con Flask**
### **‚úÖ Cambios Realizados**
‚úî **Flask ahora sirve `index.html` autom√°ticamente en `http://localhost:5000/`.**  
‚úî **Se mantiene la API REST en `http://localhost:5000/sensor` para leer datos del Arduino.**  
‚úî **No necesitas abrir manualmente `index.html` ni usar otro servidor web.**

---

## **üìÇ Organizaci√≥n del Proyecto**
üìÅ **Estructura de archivos:**
```
/progvisual
‚îÇ‚îÄ‚îÄ servidor.py   <-- C√≥digo de Flask
‚îÇ‚îÄ‚îÄ /web          <-- Carpeta con los archivos de la p√°gina web
‚îÇ   ‚îú‚îÄ‚îÄ index.html   <-- P√°gina web con la gr√°fica
‚îÇ   ‚îú‚îÄ‚îÄ script.js    <-- (Opcional) JavaScript separado
‚îÇ   ‚îú‚îÄ‚îÄ style.css    <-- (Opcional) Estilos CSS
```

---

## **üìå C√≥digo Modificado en `servidor.py`**
```python
from flask import Flask, jsonify, send_from_directory
from flask_cors import CORS
import serial
import os

# Configuraci√≥n del puerto serial
try:
    arduino = serial.Serial('COM6', 9600, timeout=3.0)  # Aseg√∫rate de cambiar el puerto seg√∫n tu sistema
    print("Conectado al Arduino.")
except Exception as e:
    print(f"Error de conexi√≥n: {e}")
    arduino = None

# Crear la aplicaci√≥n Flask
app = Flask(__name__, static_folder="web")  # Define "web" como la carpeta de archivos est√°ticos
CORS(app)  # Habilita acceso desde cualquier origen (evita problemas de CORS)

# Ruta para servir el archivo index.html
@app.route('/')
def index():
    return send_from_directory("web", "index.html")

# Ruta para servir la API que obtiene los datos del sensor
@app.route('/sensor', methods=['GET'])
def leer_sensor():
    if arduino:
        arduino.write("r".encode())  # Env√≠a el comando 'r' al Arduino
        val = arduino.readline().strip().decode('utf-8')  # Lee el valor del sensor
        try:
            return jsonify({'valor': int(val)})  # Devuelve el valor en formato JSON
        except ValueError:
            return jsonify({'valor': None, 'error': 'Error en la lectura'})
    return jsonify({'valor': None, 'error': 'Arduino no conectado'})

# Ruta para servir cualquier otro archivo (CSS, JS)
@app.route('/<path:filename>')
def servir_archivos(filename):
    return send_from_directory("web", filename)

# Iniciar el servidor Flask
if __name__ == '__main__':
    app.run(host='0.0.0.0', port=5000, debug=False)  # Servidor en modo producci√≥n
```

---

## **üìú Explicaci√≥n de los Cambios**
### **1Ô∏è‚É£ Servir `index.html` Autom√°ticamente**
```python
@app.route('/')
def index():
    return send_from_directory("web", "index.html")
```
‚úî **Ahora `http://localhost:5000/` abrir√° autom√°ticamente la p√°gina `index.html`.**  
‚úî `send_from_directory("web", "index.html")` busca el archivo dentro de la carpeta **`web/`**.

---

### **2Ô∏è‚É£ Mantener la API REST**
```python
@app.route('/sensor', methods=['GET'])
def leer_sensor():
    if arduino:
        arduino.write("r".encode())
        val = arduino.readline().strip().decode('utf-8')
        try:
            return jsonify({'valor': int(val)})  # Devuelve el valor en JSON
        except ValueError:
            return jsonify({'valor': None, 'error': 'Error en la lectura'})
    return jsonify({'valor': None, 'error': 'Arduino no conectado'})
```
‚úî **Sigue funcionando en `http://localhost:5000/sensor`**  
‚úî **Lee el valor del sensor desde Arduino y lo env√≠a como JSON.**

---

### **3Ô∏è‚É£ Permitir Archivos Est√°ticos (CSS, JS)**
```python
@app.route('/<path:filename>')
def servir_archivos(filename):
    return send_from_directory("web", filename)
```
‚úî **Si `index.html` necesita un `style.css` o `script.js`, Flask los servir√° autom√°ticamente.**  
‚úî **Ejemplo:**  
   - `http://localhost:5000/style.css`  
   - `http://localhost:5000/script.js`

---

## **üìå C√≥digo de la P√°gina Web (`index.html`)**
Guarda este archivo dentro de la carpeta `web/` como `index.html`:

```html
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Lectura en Tiempo Real</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        let datos = [];
        async function actualizarSensor() {
            let response = await fetch("http://localhost:5000/sensor");
            let data = await response.json();
            let valor = data.valor || 0;
            
            datos.push(valor);
            if (datos.length > 20) datos.shift(); // Mantener solo 20 datos en pantalla
            
            grafico.data.labels = datos.map((_, i) => i);
            grafico.data.datasets[0].data = datos;
            grafico.update();
        }

        setInterval(actualizarSensor, 1000);
    </script>
</head>
<body>
    <h2>Valor del Sensor</h2>
    <canvas id="grafico"></canvas>

    <script>
        let ctx = document.getElementById('grafico').getContext('2d');
        let grafico = new Chart(ctx, {
            type: 'line',
            data: {
                labels: [],
                datasets: [{
                    label: 'Valor del Sensor',
                    data: [],
                    borderColor: 'blue',
                    borderWidth: 2
                }]
            },
            options: {
                responsive: true,
                scales: {
                    y: { beginAtZero: true }
                }
            }
        });
    </script>
</body>
</html>
```

---

## **üìå Instrucciones Finales**
### **1Ô∏è‚É£ Ejecutar Flask**
Abre una terminal en la carpeta donde est√° `servidor.py` y ejecuta:
```sh
python servidor.py
```
üìå **Si todo est√° bien, deber√≠as ver esto:**
```
Conectado al Arduino.
 * Running on http://127.0.0.1:5000/
```

### **2Ô∏è‚É£ Abrir el Navegador**
Abre:
```
http://localhost:5000/
```
üìå **La p√°gina web se abrir√° autom√°ticamente y mostrar√° la gr√°fica en tiempo real.**

---

## **üéØ Conclusi√≥n**
‚úÖ **Flask ahora sirve la API y la p√°gina web al mismo tiempo.**  
‚úÖ **No necesitas abrir `index.html` manualmente ni usar `python -m http.server`.**  
‚úÖ **Puedes agregar archivos CSS y JS a la carpeta `web/` y Flask los servir√° autom√°ticamente.**  
